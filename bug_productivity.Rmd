---
title: "bug_productivity"
author: "Lydia Bleifuss"
date: "5/2/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r load packages, echo=TRUE, message=FALSE}
library(DeclareDesign)
library(knitr)
library(ggplot2)
library(grid)
library(gridExtra)
library(dplyr)
library(kableExtra)
```

```{r bug declare pop, echo=TRUE, message=F, eval=TRUE, cache=TRUE}

#declaring population of bug grids

set.seed(228)
population <- declare_population(
  pollinator_grids = add_level(N=3250000, 
     bug_count=runif(n=N, min=0, max=30))
)
pop <- population()
plot <- ggplot(pop, aes(x=bug_count)) + 
  geom_histogram(color="black", fill="white")
plot
```

```{r bug sample, echo=TRUE, message=F, eval=TRUE}

#Drawing a sample

sam <- sample(1:3250000,40)
plot2 <- ggplot(pop, aes(x=bug_count)) + 
  geom_histogram(color="black", fill="white") +
  geom_histogram(data=pop[sam,], fill = "black")

plot2
```

## Conceptual practice: stratification

- Describe a monitoring situation where you might want to use stratified sampling
    + What are the strata?
    + How would you allocate sampling effort across the strata?

## DeclareDesign()

```{r declare-pop}
set.seed(228)
population <- declare_population(
  households = add_level(N=500, 
     main=draw_binary(N=N, prob = 0.5),
     satisfied=correlate(given = main, rho = 0.5,
                         draw_binary, prob = 0.5)
))

my_estimand <- declare_estimands(mean(satisfied),
                                 label = "Ybar")
```

## DeclareDesign()

```{r declare-report}
reporting <- declare_assignment(blocks=main,
                  assignment_variable = "R",
                  block_prob=c(0.2,0.5))

sampling <- declare_sampling(strata=main,
                             strata_n=c(175,75))

```

## DeclareDesign()

```{r declare-estimator}

strata_weighted_mean <- function(data){
  data.frame(  
  estimator_label = "strata_w_mean",
  estimand_label = "Ybar",
  n = nrow(data),
  stringsAsFactors = FALSE,
  
  estimate = data %>% filter(R==1) %>%
    group_by(main) %>% 
    summarise(mean=mean(satisfied)) %>%
    mutate(prop=c(0.5,0.5)) %>%
    mutate(sub.mean=mean*prop) %>% pull(sub.mean) %>% 
    sum())
} #just use this function, custom

```

## DeclareDesign()

```{r diagnosis, cache=TRUE}

answer <- declare_estimator(
  handler = tidy_estimator(strata_weighted_mean),
  estimand = my_estimand)

design <- population + my_estimand + reporting +
          sampling + answer
diagnosis <- diagnose_design(design, sims = 1000)

diagnosis$diagnosands_df[,c(4,5,12,14)] %>%
  kable()

```